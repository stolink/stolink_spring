version: "3.8"

services:
  # Spring Boot Application
  backend:
    image: ${IMAGE_NAME:-stolink-backend:local}
    container_name: stolink-backend
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      # PostgreSQL
      POSTGRESQL_URL: ${POSTGRESQL_URL}
      POSTGRESQL_PORT: ${POSTGRESQL_PORT}
      POSTGRESQL_USERNAME: ${POSTGRESQL_USERNAME}
      POSTGRESQL_PASSWORD: ${POSTGRESQL_PASSWORD}
      # Neo4j
      NEO4J_URI: ${NEO4J_URI}
      NEO4J_USERNAME: ${NEO4J_USERNAME}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      NEO4J_PORT: ${NEO4J_PORT}
      # RabbitMQ - Image (이미지 생성용)
      RABBITMQ_IMAGE_HOST: ${RABBITMQ_IMAGE_HOST}
      RABBITMQ_IMAGE_PORT: ${RABBITMQ_IMAGE_PORT}
      RABBITMQ_IMAGE_VHOST: ${RABBITMQ_IMAGE_VHOST}
      RABBITMQ_IMAGE_USER: ${RABBITMQ_IMAGE_USER}
      RABBITMQ_IMAGE_PASSWORD: ${RABBITMQ_IMAGE_PASSWORD}
      # RabbitMQ - Agent (분석용)
      RABBITMQ_AGENT_HOST: ${RABBITMQ_AGENT_HOST}
      RABBITMQ_AGENT_PORT: ${RABBITMQ_AGENT_PORT}
      RABBITMQ_AGENT_VHOST: ${RABBITMQ_AGENT_VHOST}
      RABBITMQ_AGENT_USER: ${RABBITMQ_AGENT_USER}
      RABBITMQ_AGENT_PASSWORD: ${RABBITMQ_AGENT_PASSWORD}
      # AI Callback URL
      APP_AI_CALLBACK_BASE_URL: ${APP_AI_CALLBACK_BASE_URL}
      # Storage path
      APP_STORAGE_BASE_PATH: /app/storage/uploads
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:5174}
      # OAuth2 (Google)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_COOKIE_DOMAIN: ${JWT_COOKIE_DOMAIN:-localhost}
      # OAuth2 Redirect
      OAUTH2_REDIRECT_URI: ${OAUTH2_REDIRECT_URI:-http://localhost:3000/oauth2/callback}
      # Storead API 연동
      STOREAD_SPRING_URL: ${STOREAD_SPRING_URL}
      STOREAD_SPRING_SERVICE_KEY: ${STOREAD_SPRING_SERVICE_KEY:-temp-key}
    ports:
      - "8080:8080"
    volumes:
      - backend_storage:/app/storage/uploads
    networks:
      - stolink-network
    restart: unless-stopped

volumes:
  backend_storage:

networks:
  stolink-network:
    driver: bridge
