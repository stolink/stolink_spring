# Spring Boot만 실행하는 Docker Compose 파일
# 외부 compose에서 실행 중인 DB들(PostgreSQL, Neo4j, RabbitMQ)과 연동
#
# 사용법:
# 1. 먼저 외부 네트워크 이름 확인: docker network ls
# 2. 네트워크 이름이 다르면 아래 networks 섹션 수정
# 3. 실행: docker compose -f docker-compose.spring.yml up --build -d
# 4. 중지: docker compose -f docker-compose.spring.yml down

version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stolink-backend
    environment:
      SPRING_PROFILES_ACTIVE: local
      # PostgreSQL (컨테이너 이름으로 접근)
      SPRING_DATASOURCE_URL: jdbc:postgresql://stolink-postgres:5432/stolink
      SPRING_DATASOURCE_USERNAME: stolink
      SPRING_DATASOURCE_PASSWORD: stolink123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      # Neo4j
      SPRING_NEO4J_URI: bolt://stolink-neo4j:7687
      SPRING_NEO4J_AUTHENTICATION_USERNAME: neo4j
      SPRING_NEO4J_AUTHENTICATION_PASSWORD: stolink123
      # RabbitMQ
      # RabbitMQ Configuration for Custom Config
      # Image RabbitMQ (application-local.yml 환경변수명과 일치)
      RABBITMQ_IMAGE_HOST: stolink-rabbitmq
      RABBITMQ_IMAGE_PORT: 5672
      RABBITMQ_IMAGE_USERNAME: stolink
      RABBITMQ_IMAGE_PASSWORD: stolink123
      RABBITMQ_IMAGE_VHOST: stolink
      # Agent RabbitMQ (AI 분석용) - application-local.yml 환경변수명과 일치
      SPRING_RABBITMQ_HOST: stolink-rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: stolink
      SPRING_RABBITMQ_PASSWORD: stolink123
      SPRING_RABBITMQ_VIRTUAL_HOST: stolink
      # RabbitMQ Queue Names
      APP_RABBITMQ_QUEUES_ANALYSIS: stolink.analysis.queue
      APP_RABBITMQ_QUEUES_IMAGE: stolink.image.queue
      APP_RABBITMQ_QUEUES_DOCUMENT_ANALYSIS: document_analysis_queue
      APP_RABBITMQ_QUEUES_GLOBAL_MERGE: global_merge_queue
      # AI Callback URL
      APP_AI_CALLBACK_BASE_URL: http://stolink-backend:8080/api/ai-callback
      APP_CALLBACK_BASE_URL: http://stolink-backend:8080
      # Analysis Settings
      APP_ANALYSIS_MAX_RETRY_COUNT: 3
      # Storage path
      APP_STORAGE_BASE_PATH: /app/storage/uploads
    ports:
      - "8080:8080"
    volumes:
      - backend_storage:/app/storage/uploads
    networks:
      - ai-backend-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 3s
      start_period: 60s
      retries: 3

volumes:
  backend_storage:


networks:
  ai-backend-network:
    external: true
    name: sto-link-ai-backend_stolink-network
