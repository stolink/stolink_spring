# Spring Boot만 실행하는 Docker Compose 파일
# 외부 compose에서 실행 중인 DB들(PostgreSQL, Neo4j, RabbitMQ)과 연동
#
# 사용법:
# 1. 먼저 외부 네트워크 이름 확인: docker network ls
# 2. 네트워크 이름이 다르면 아래 networks 섹션 수정
# 3. 실행: docker compose -f docker-compose.spring.yml up --build -d
# 4. 중지: docker compose -f docker-compose.spring.yml down

version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stolink-backend
    environment:
      # PostgreSQL (컨테이너 이름으로 접근)
      SPRING_DATASOURCE_URL: jdbc:postgresql://stolink-postgres:5432/stolink
      SPRING_DATASOURCE_USERNAME: stolink
      SPRING_DATASOURCE_PASSWORD: stolink123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      # Neo4j
      SPRING_NEO4J_URI: bolt://stolink-neo4j:7687
      SPRING_NEO4J_AUTHENTICATION_USERNAME: neo4j
      SPRING_NEO4J_AUTHENTICATION_PASSWORD: stolink123
      # RabbitMQ
      # RabbitMQ Configuration for Custom Config
      # Image RabbitMQ
      APP_RABBITMQ_IMAGE_HOST: stolink-rabbitmq
      APP_RABBITMQ_IMAGE_PORT: 5672
      APP_RABBITMQ_IMAGE_USERNAME: stolink
      APP_RABBITMQ_IMAGE_PASSWORD: stolink123
      APP_RABBITMQ_IMAGE_VIRTUAL_HOST: /
      # Agent RabbitMQ
      APP_RABBITMQ_AGENT_HOST: stolink-rabbitmq
      APP_RABBITMQ_AGENT_PORT: 5672
      APP_RABBITMQ_AGENT_USERNAME: stolink
      APP_RABBITMQ_AGENT_PASSWORD: stolink123
      APP_RABBITMQ_AGENT_VIRTUAL_HOST: /
      # AI Callback URL
      APP_AI_CALLBACK_BASE_URL: http://stolink-backend:8080/api/internal/ai
      # Storage path
      APP_STORAGE_BASE_PATH: /app/storage/uploads
    ports:
      - "8080:8080"
    volumes:
      - backend_storage:/app/storage/uploads
    networks:
      - ai-backend-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 3s
      start_period: 60s
      retries: 3

volumes:
  backend_storage:


networks:
  ai-backend-network:
    external: true
    name: sto-link-ai-backend_stolink-network
