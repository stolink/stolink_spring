# 로컬 개발용 Docker Compose 파일
# PostgreSQL, Neo4j, RabbitMQ, Spring Boot 모두 포함
#
# 사용법:
# 1. 실행: docker compose -f docker-compose.local.yml up --build -d
# 2. 중지: docker compose -f docker-compose.local.yml down
# 3. 데이터 삭제 포함 중지: docker compose -f docker-compose.local.yml down -v

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16.11-alpine
    container_name: stolink-postgres-local
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - stolink-local-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U stolink -d stolink"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Graph Database
  neo4j:
    image: neo4j:5.26-community
    container_name: stolink-neo4j-local
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc"]'
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - stolink-local-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:7474",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker (Main - Image Generation)
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: stolink-rabbitmq-local
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - stolink-local-network
    restart: unless-stopped
    healthcheck:
      test: >
        rabbitmq-diagnostics -q ping &&
        rabbitmqctl list_vhosts | grep -q stolink ||
        (rabbitmqctl add_vhost stolink && rabbitmqctl set_permissions -p stolink guest ".*" ".*" ".*")
      interval: 10s
      timeout: 10s
      retries: 5

  # RabbitMQ Message Broker (AI Agent용 - FastAPI 연결)
  rabbitmq-agent:
    image: rabbitmq:3.13-management-alpine
    container_name: stolink-rabbitmq-agent
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5673:5672" # AMQP (외부 포트 5673)
      - "15673:15672" # Management UI (외부 포트 15673)
    volumes:
      - rabbitmq_agent_data:/var/lib/rabbitmq
    networks:
      - stolink-local-network
    restart: unless-stopped
    healthcheck:
      test: >
        rabbitmq-diagnostics -q ping &&
        rabbitmqctl list_vhosts | grep -q stolink ||
        (rabbitmqctl add_vhost stolink && rabbitmqctl set_permissions -p stolink guest ".*" ".*" ".*")
      interval: 10s
      timeout: 10s
      start_period: 30s
      retries: 5

  # Spring Boot Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stolink-backend
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      rabbitmq-agent:
        condition: service_healthy
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: local
      # PostgreSQL
      SPRING_DATASOURCE_URL: jdbc:postgresql://stolink-postgres-local:5432/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      # Neo4j
      SPRING_NEO4J_URI: bolt://stolink-neo4j-local:7687
      SPRING_NEO4J_AUTHENTICATION_USERNAME: ${NEO4J_USER}
      SPRING_NEO4J_AUTHENTICATION_PASSWORD: ${NEO4J_PASSWORD}
      # RabbitMQ (Analysis - AI Agent용)
      SPRING_RABBITMQ_HOST: stolink-rabbitmq-agent
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USER}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      SPRING_RABBITMQ_VIRTUAL_HOST: stolink
      # RabbitMQ (Image Generation - 기존 RabbitMQ)
      RABBITMQ_IMAGE_HOST: stolink-rabbitmq-local
      RABBITMQ_IMAGE_PORT: 5672
      RABBITMQ_IMAGE_USERNAME: ${RABBITMQ_USER}
      RABBITMQ_IMAGE_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_IMAGE_VHOST: stolink
      # AI Callback URL
      APP_AI_CALLBACK_BASE_URL: http://stolink-backend:8080/api/internal/ai
      # Storage path
      APP_STORAGE_BASE_PATH: /app/storage/uploads
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      # OAuth2 (Google)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      OAUTH2_REDIRECT_URI: ${OAUTH2_REDIRECT_URI}
      # Security (JWT)
      JWT_SECRET: ${JWT_SECRET}
      JWT_COOKIE_DOMAIN: ${JWT_COOKIE_DOMAIN}
    ports:
      - "8080:8080"
    volumes:
      - backend_storage:/app/storage/uploads
    networks:
      - stolink-local-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/actuator/health",
        ]
      interval: 30s
      timeout: 3s
      start_period: 60s
      retries: 3

volumes:
  postgres_data:
  neo4j_data:
  neo4j_logs:
  rabbitmq_data:
  rabbitmq_agent_data:
  backend_storage:

networks:
  stolink-local-network:
    name: stolink-shared-network # Spring/FastAPI 공통 네트워크 - 먼저 실행하는 쪽에서 생성
    driver: bridge
