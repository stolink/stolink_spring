name: AI Code Review

on:
  # ì½”ë©˜íŠ¸ë¡œ íŠ¸ë¦¬ê±° (/review) - ìˆ˜ë™ ì‹¤í–‰
  issue_comment:
    types: [created]
  # PR ìƒì„± ë° ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize]

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - ê°™ì€ PRì—ì„œ ì—¬ëŸ¬ ë¦¬ë·°ê°€ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡
# cancel-in-progress: falseë¡œ ì„¤ì •í•˜ì—¬ ê¸°ì¡´ ë¦¬ë·°ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
concurrency:
  group: ai-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  ai_review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            BASE_BRANCH=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq '.baseRefName')
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files and diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="${{ steps.pr.outputs.base_branch }}"
          git fetch origin $BASE_BRANCH

          # ë³€ê²½ëœ íŒŒì¼ ìˆ˜ (head ì ìš© ì „, ì •ìˆ˜ ë³´ì¥) - Java/Spring Boot í”„ë¡œì íŠ¸ìš©
          FILES_COUNT=$(git diff origin/$BASE_BRANCH...HEAD --name-only -- '*.java' '*.yml' '*.gradle' '*.sql' | wc -l | tr -d ' ')
          FILES_COUNT=${FILES_COUNT:-0}
          echo "files_count=$FILES_COUNT" >> $GITHUB_OUTPUT

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (ìµœëŒ€ 30ê°œ)
          FILES=$(git diff origin/$BASE_BRANCH...HEAD --name-only -- '*.java' '*.yml' '*.gradle' '*.sql' | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ë³€ê²½ ì‚¬í•­ í†µê³„ (ì •ìˆ˜ ë³´ì¥)
          DIFF_STAT=$(git diff origin/$BASE_BRANCH...HEAD --stat | tail -1)
          DIFF_LINES=$(git diff origin/$BASE_BRANCH...HEAD -- '*.java' '*.yml' '*.gradle' '*.sql' | wc -l | tr -d ' ')
          DIFF_LINES=${DIFF_LINES:-0}
          echo "diff_stat=$DIFF_STAT" >> $GITHUB_OUTPUT
          echo "diff_lines=$DIFF_LINES" >> $GITHUB_OUTPUT

          # ë¹ˆ diff ì²´í¬ (FILES_COUNT ì‚¬ìš© - head ì ìš© ì „ ê°’)
          if [ "$DIFF_LINES" -eq 0 ] || [ "$FILES_COUNT" -eq 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

          # ì‹¤ì œ ì½”ë“œ ë³€ê²½ ë‚´ìš© (10,000ì¤„ ì œí•œ)
          git diff origin/$BASE_BRANCH...HEAD -- '*.java' '*.yml' '*.gradle' '*.sql' | head -10000 > diff_content.txt

      - name: Skip if no changes
        if: steps.diff.outputs.skip == 'true'
        run: |
          echo "ë¦¬ë·°í•  ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. (*.java, *.yml, *.gradle, *.sql íŒŒì¼ ë³€ê²½ ì—†ìŒ)" > review_result.txt

      - name: Prepare prompt and call Gemini API
        id: review
        if: steps.diff.outputs.skip != 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "API Error: GEMINI_API_KEY is missing." > review_result.txt
            exit 1
          fi

          # Pythonìœ¼ë¡œ ì•ˆì „í•˜ê²Œ JSON ìƒì„± ë° API í˜¸ì¶œ
          python3 << 'PYEOF'
          import json
          import urllib.request
          import urllib.error
          import sys
          import os

          # diff ë‚´ìš© ì½ê¸° (ì•ˆì „í•œ ë°©ì‹)
          with open('diff_content.txt', 'r', encoding='utf-8', errors='replace') as f:
              diff_content = f.read()

          files = """${{ steps.diff.outputs.files }}"""
          diff_stat = "${{ steps.diff.outputs.diff_stat }}"
          diff_lines = "${{ steps.diff.outputs.diff_lines }}"

          files_count = "${{ steps.diff.outputs.files_count }}"

          # ì œí•œ ì‚¬í•­ ê²½ê³  ë©”ì‹œì§€ ìƒì„±
          truncated_notice = ""
          notices = []
          if int(diff_lines) > 10000:
              notices.append(f"diff ë¼ì¸ ìˆ˜ê°€ {diff_lines}ì¤„ë¡œ 10,000ì¤„ì„ ì´ˆê³¼í•˜ì—¬ ì¼ë¶€ë§Œ ë¦¬ë·°í•©ë‹ˆë‹¤.")
          if int(files_count) > 30:
              notices.append(f"ë³€ê²½ëœ íŒŒì¼ì´ {files_count}ê°œë¡œ 30ê°œë¥¼ ì´ˆê³¼í•˜ì—¬ ì¼ë¶€ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.")
          if notices:
              truncated_notice = "\n\n**Note:** " + " ".join(notices)

          prompt = f"""ë‹¹ì‹ ì€ StoLink Backend í”„ë¡œì íŠ¸(Java 21/Spring Boot 3.4.1)ì˜ ì‹œë‹ˆì–´ ë°±ì—”ë“œ ê°œë°œìì´ì DBA ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

          ## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
          - Spring Boot 3.4.1 ê¸°ë°˜ REST API ì„œë²„
          - PostgreSQL 16 + Neo4j 5.26 ì´ì¤‘ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°
          - FastAPI AI ì„œë¹„ìŠ¤ì™€ RabbitMQ ë¹„ë™ê¸° ì—°ë™
          - ê¸°ìˆ  ìŠ¤íƒ: Java 21, Spring Data JPA, QueryDSL, Hibernate 6.x

          ## ë³€ê²½ ìš”ì•½
          {diff_stat}{truncated_notice}

          ## ë³€ê²½ëœ íŒŒì¼
          {files}

          ## ì½”ë“œ ë³€ê²½ì‚¬í•­
          ```diff
          {diff_content}
          ```

          ## ë¦¬ë·° ìš°ì„ ìˆœìœ„
          1. ğŸ”´ ì¹˜ëª…ì : ëŸ°íƒ€ì„ ì—ëŸ¬, SQL Injection, N+1 ì¿¼ë¦¬, ë°ì´í„° ì •í•©ì„± ì´ìŠˆ
          2. âš ï¸ ê²½ê³ : ì„±ëŠ¥ ì´ìŠˆ, íŠ¸ëœì­ì…˜ ë²”ìœ„ ë¬¸ì œ, ì•ˆí‹°íŒ¨í„´
          3. ğŸ’¡ ì œì•ˆ: ì½”ë“œ ìŠ¤íƒ€ì¼, ë¦¬íŒ©í† ë§ (ì„ íƒì‚¬í•­)

          ## ì£¼ìš” ì²´í¬í¬ì¸íŠ¸
          - N+1 ì¿¼ë¦¬ ë°œìƒ ì—¬ë¶€ (fetch join ë˜ëŠ” @EntityGraph ì‚¬ìš© í™•ì¸)
          - Entity ì§ì ‘ API ì‘ë‹µ ë…¸ì¶œ (DTO ë³€í™˜ í•„ìˆ˜)
          - íŠ¸ëœì­ì…˜ ë‚´ ì™¸ë¶€ API í˜¸ì¶œ ê¸ˆì§€
          - SELECT * ì‚¬ìš© ê¸ˆì§€
          - ë£¨í”„ ë‚´ DB ì¿¼ë¦¬ ì‹¤í–‰ ê¸ˆì§€

          ## ë¦¬ë·° ì§€ì‹œì‚¬í•­
          - ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”
          - ğŸ”´ ì¹˜ëª…ì , âš ï¸ ê²½ê³ ê°€ ì—†ìœ¼ë©´ 'âœ… ì½”ë“œ ë¦¬ë·° í†µê³¼' ì¶œë ¥
          - ğŸ’¡ ì œì•ˆì€ ì„ íƒì‚¬í•­ì´ë¯€ë¡œ 'ìˆ˜ì • í•„ìš”'ë¡œ ì·¨ê¸‰í•˜ì§€ ì•ŠìŒ
          - ì‘ë‹µ í˜•ì‹ ì™¸ì˜ ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ëŠ” ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”

          ## ì‘ë‹µ í˜•ì‹
          ### ìš”ì•½
          (1-2ë¬¸ì¥ìœ¼ë¡œ ì „ì²´ ë³€ê²½ì‚¬í•­ ìš”ì•½)

          ### ğŸ”´ ì¹˜ëª…ì  (Nê±´)
          **íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©
          - ë¬¸ì œ: ì„¤ëª…
          - ê°œì„ : ì½”ë“œ ì˜ˆì‹œ
          (ì—†ìœ¼ë©´ ì´ ì„¹ì…˜ ìƒëµ)

          ### âš ï¸ ê²½ê³  (Nê±´)
          **íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©
          > ì„¤ëª…
          (ì—†ìœ¼ë©´ ì´ ì„¹ì…˜ ìƒëµ)

          ### ğŸ’¡ ì œì•ˆ
          - (ìˆë‹¤ë©´ ê°„ê²°í•˜ê²Œ 1-3ê°œë§Œ ì œì•ˆ, ì—†ìœ¼ë©´ ìƒëµ)"""

          # Gemini API í˜¸ì¶œ
          api_key = os.environ.get('GEMINI_API_KEY')
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"

          payload = {
              "contents": [{"parts": [{"text": prompt}]}],
              "generationConfig": {
                  "temperature": 0.7,
                  "maxOutputTokens": 4096
              }
          }

          try:
              req = urllib.request.Request(
                  url,
                  data=json.dumps(payload).encode('utf-8'),
                  headers={'Content-Type': 'application/json'},
                  method='POST'
              )
              with urllib.request.urlopen(req, timeout=120) as response:
                  result = json.loads(response.read().decode('utf-8'))

              # Gemini ì‘ë‹µ íŒŒì‹±
              review = result.get('candidates', [{}])[0].get('content', {}).get('parts', [{}])[0].get('text', 'ë¦¬ë·° ìƒì„± ì‹¤íŒ¨')
              with open('review_result.txt', 'w', encoding='utf-8') as f:
                  f.write(review)

          except urllib.error.HTTPError as e:
              error_body = e.read().decode('utf-8') if e.fp else str(e)
              with open('review_result.txt', 'w') as f:
                  f.write(f"Gemini API Error ({e.code}): {error_body}")
              sys.exit(1)
          except Exception as e:
              with open('review_result.txt', 'w') as f:
                  f.write(f"API Error: {e}")
              sys.exit(1)
          PYEOF

      - name: Post review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = 'ë¦¬ë·° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            try {
              review = fs.readFileSync('review_result.txt', 'utf8');
            } catch (e) {
              review = `íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${e.message}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·° (Gemini Flash)\n\n${review}`
            });
