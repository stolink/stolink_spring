name: AI Code Review

on:
  # ì½”ë©˜íŠ¸ë¡œ íŠ¸ë¦¬ê±° (/review) - ìˆ˜ë™ ì‹¤í–‰
  issue_comment:
    types: [created]
  # PR ìƒì„± ë° ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            # ì½”ë©˜íŠ¸ íŠ¸ë¦¬ê±° ì‹œì—ë„ PR ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì™€ base branch í™•ì¸
            BASE_BRANCH=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq '.baseRefName')
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files and diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="${{ steps.pr.outputs.base_branch }}"
          git fetch origin $BASE_BRANCH

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ (Java, ì„¤ì • íŒŒì¼ í¬í•¨)
          FILES=$(git diff origin/$BASE_BRANCH...HEAD --name-only -- '*.java' '*.yml' '*.gradle' '*.sql' | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì‹¤ì œ ì½”ë“œ ë³€ê²½ ë‚´ìš©
          DIFF=$(git diff origin/$BASE_BRANCH...HEAD -- '*.java' '*.yml' '*.gradle' '*.sql' | head -500)
          echo "$DIFF" > diff_content.txt

      - name: Prepare prompt
        id: prompt
        run: |
          DIFF_CONTENT=$(head -n 500 diff_content.txt)
          FILES="${{ steps.diff.outputs.files }}"

          # Extract coding_rules and ai_code_review section from CLAUDE.md
          if [ -f "CLAUDE.md" ]; then
            # Extract content from <coding_rules> and <ai_code_review>
            CODING_RULES=$(sed -n '/<coding_rules>/,/<\/coding_rules>/p' CLAUDE.md)
            REVIEW_CONTEXT=$(sed -n '/<ai_code_review>/,/<\/ai_code_review>/p' CLAUDE.md | sed '1d;$d')
          else
            CODING_RULES="í‘œì¤€ Java/Spring Boot ì½”ë”© ê·œì¹™ì„ ë”°ë¦…ë‹ˆë‹¤."
            REVIEW_CONTEXT="StoLink í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ ê°œë°œìë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          fi

          # Create template file
          cat << 'EOF' > prompt_template.txt
          SYSTEM_CONTEXT_PLACEHOLDER

          ## í”„ë¡œì íŠ¸ ì½”ë”© ê·œì¹™
          CODING_RULES_PLACEHOLDER

          ## ë³€ê²½ëœ íŒŒì¼
          FILES_PLACEHOLDER

          ## ì½”ë“œ ë³€ê²½ ë‚´ìš©
          ```diff
          DIFF_PLACEHOLDER
          ```

          ìœ„ ê·œì¹™ê³¼ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë³€ê²½ëœ ì½”ë“œë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”.
          í•­ìƒ í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ë©°, ì¶œë ¥ í˜•ì‹ì„ ì •í™•íˆ ì§€ì¼œì£¼ì„¸ìš”.
          EOF

          # Use jq to generate JSON safely
          jq -n \
            --arg model "claude-haiku-4-5-20251001" \
            --rawfile template prompt_template.txt \
            --arg context "$REVIEW_CONTEXT" \
            --arg rules "$CODING_RULES" \
            --arg files "$FILES" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: $model,
              max_tokens: 4096,
              messages: [{
                role: "user",
                content: ($template | sub("SYSTEM_CONTEXT_PLACEHOLDER"; $context) | sub("CODING_RULES_PLACEHOLDER"; $rules) | sub("FILES_PLACEHOLDER"; $files) | sub("DIFF_PLACEHOLDER"; $diff))
              }]
            }' > prompt.json

      - name: Call Claude API
        id: review
        run: |
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @prompt.json)

          # Extract text from response
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "ë¦¬ë·° ìƒì„± ì‹¤íŒ¨"')

          # Check for error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "API Error: $ERROR" > review_result.txt
          else
            echo "$REVIEW" > review_result.txt
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n${review}`
            });
