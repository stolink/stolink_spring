package com.stolink.backend.global.security.oauth2;

import com.stolink.backend.domain.user.entity.AuthProvider;
import com.stolink.backend.domain.user.entity.User;
import com.stolink.backend.domain.user.repository.UserRepository;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.security.oauth2.client.registration.ClientRegistration;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.AuthorizationGrantType;
import org.springframework.security.oauth2.core.OAuth2AccessToken;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.transaction.annotation.Transactional;

import java.time.Instant;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@Transactional
class CustomOAuth2UserServiceTest {

    @Autowired
    private CustomOAuth2UserService customOAuth2UserService;

    @Autowired
    private UserRepository userRepository;

    private OAuth2UserRequest createGoogleRequest(Map<String, Object> attributes) {
        ClientRegistration registration = ClientRegistration.withRegistrationId("google")
                .clientId("google-client-id")
                .clientSecret("google-client-secret")
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
                .redirectUri("http://localhost:8080/login/oauth2/code/google")
                .scope("email", "profile")
                .authorizationUri("https://accounts.google.com/o/oauth2/v2/auth")
                .tokenUri("https://www.googleapis.com/oauth2/v4/token")
                .userInfoUri("https://www.googleapis.com/oauth2/v3/userinfo")
                .userNameAttributeName("sub")
                .clientName("Google")
                .build();

        OAuth2AccessToken accessToken = new OAuth2AccessToken(
                OAuth2AccessToken.TokenType.BEARER,
                "access-token",
                Instant.now(),
                Instant.now().plusSeconds(3600)
        );

        return new OAuth2UserRequest(registration, accessToken) {
            @Override
            public Map<String, Object> getAdditionalParameters() {
                return attributes;
            }
        };
    }

    // Mocking the super.loadUser call is tricky because CustomOAuth2UserService extends DefaultOAuth2UserService.
    // However, since verify logic is inside `processGoogleUser` which is called AFTER `super.loadUser`,
    // and `super.loadUser` does a network call, we might run into issues.
    //
    // Actually, CustomOAuth2UserService extends DefaultOAuth2UserService.
    // To unit test the internal logic without network, we should probably refactor or use Mockito spy.
    // Integration test with real network call will fail.
    //
    // Strategy: Since I cannot easily mock the super class method in a simple @SpringBootTest without specialized structure,
    // I will use @MockBean or Mockito in a slice test, OR just rely on code review because network calls are blocked/undesirable.
}
